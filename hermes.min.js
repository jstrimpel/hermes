// HERMES, sweet llamas of the bahamas
// ----------------------------------
// v0.0.1
//
// Copyright (c)2013 Jason Strimpel
// Distributed under MIT license
!function(a){function b(a,b,c){for(var d in b)c&&c[d]||(a[d]=b[d]);return a}function c(a){return"[object RegExp]"===Object.prototype.toString.call(a)}function d(a){return"function"==typeof a}var e,f=/\((.*?)\)/g,g=/(\(\?)?:\w+/g,h=/\*\w+/g,i=/[\-{}\[\]+?.,\\\^$|#\s]/g,j=/^\/+|\/+$/g,k=/\/$/;e={start:function(c){var d=this;return this._started||!a.history.pushState?this:(c=c||{},this._handlers=this._handlers||[],this._cache=this._cache||{},b(this,c,{state:!0,title:!0}),this.root=this.root?("/"+this.root+"/").replace(j,"/"):void 0,c.state=c.state||{},c.title=c.title||document.title,a.history.replaceState(c.state||{},c.title,this._getUrl()),document.title=c.title,this._setCacheItem(c.title,c.state),this._lastUrl={pathname:a.location.pathname,search:a.location.search},d._backboneEvents(),d._bindRoutes(),setTimeout(function(){d._bindPopState()},0),this._started=!0,this)},stop:function(){a.removeEventListener("popstate",this._popstateListener),this._started=!1},route:function(b,e,f){var g,h=this,i=b.match(/:\w*/g)||[];return b=c(b)?b:this._routeToRegExp(b),d(e)&&(f=e,e=""),this._handlers=this._handlers||[],this._handlers.unshift({route:b,callback:function(c){g=h._getParams(b,i),d(f)&&f.apply(h,[a.location.pathname,g,c]),h._backboneEventsAugmented&&(h.trigger.apply(h,["route:"+e].concat(g,c)),h.trigger("route",e,g,c))}}),this},destroyRoutes:function(){this._handlers=[]},navigate:function(b,c){c=c||{},c.state=c.state||{},c.title=c.title||document.title,a.history[c.replace?"replaceState":"pushState"](c.state,c.title,b),document.title=c.title,this._setCacheItem(c.title,c.state),(void 0===c.trigger||c.trigger)&&this._loadUrl(c.state)},getItem:function(a){return this._cache[a||this._getUrl()]},clearCache:function(){return this._cache={},this},_setCacheItem:function(a,b){var c=this._cache[this._getUrl()]={title:a};return this.cache&&(c.state=b),this},_getUrl:function(){return a.location.pathname+a.location.search},_getParams:function(b,c){var d,e,f=/\+/g,g=/([^&=]+)=?([^&]*)/g,h=function(a){return decodeURIComponent(a.replace(f," "))},i=a.location.search.substring(1),j={};e=b.exec(this._stripRoot(a.location.pathname)).slice(1);for(var k=0;k<c.length;k++)j[c[k].substring(1)]=e[k]||null;for(;d=g.exec(i);)j[h(d[1])]=h(d[2]);return j},_routeToRegExp:function(a){return a=a.replace(i,"\\$&").replace(f,"(?:$1)?").replace(g,function(a,b){return b?a:"([^/]+)"}).replace(h,"(.*?)"),new RegExp("^"+a+"$")},_stripRoot:function(a){var b;return a="/"===a.substring(0,1)?a.substring(1):a,this.root?(b=this.root.replace(k,""),a=0===a.indexOf(b)?a.substr(b.length):void 0):a},_backboneEvents:function(){return!this.Backbone||this._backboneEventsAugmented?this:(b(this,Backbone.Events),this._backboneEventsAugmented=!0,this)},_bindPopState:function(){var b=this;return this._popstateListener=a.addEventListener("popstate",function(a){var c=b.getItem();b._loadUrl(a.state),document.title=c?c.title:document.title}),this},_bindRoutes:function(){var a;if(!this.routes||this._routesBound)return this;a=d(this.routes)?this.routes():this.routes;for(var b in this.routes)this.route(b,this.routes[b]);return this._routesBound=!0,this},_loadUrl:function(b){var c=this._handlers,d=this._stripRoot(a.location.pathname),e=c.length;b=b||{};for(var f=0;e>f;f++)if(c[f].route.test(d)){c[f].callback(b),this._lastUrl={pathname:a.location.pathname,search:a.location.search};break}return this}},a.define&&d(a.define)?a.define(e):a.hermes=e}(this);