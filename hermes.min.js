// HERMES, sweet llamas of the bahamas
// ----------------------------------
// v0.0.1
//
// Copyright (c)2013 Jason Strimpel
// Distributed under MIT license
!function(a){function b(a,b){for(var c in b)a[c]=b[c];return a}function c(a){return"[object RegExp]"===Object.prototype.toString.call(a)}function d(a){return"function"==typeof a}var e,f=/\((.*?)\)/g,g=/(\(\?)?:\w+/g,h=/\*\w+/g,i=/[\-{}\[\]+?.,\\\^$|#\s]/g,j=/^\/+|\/+$/g,k=/\/$/;e={start:function(c){var d=this;return this._started||!a.history.pushState?this:(c=c||{},this._handlers=this._handlers||[],b(this,c),this.root=this.root?("/"+this.root+"/").replace(j,"/"):void 0,a.history.replaceState(c.data||{},document.title,a.location.pathname+a.location.search),this._lastUrl={pathname:a.location.pathname,search:a.location.search},d._backboneEvents(),d._bindRoutes(),setTimeout(function(){d._bindPopState()},0),this._started=!0,this)},stop:function(){a.removeEventListener("popstate",this._popstateListener),this._started=!1},route:function(b,e,f){var g,h=this;return b=c(b)?b:this._routeToRegExp(b),d(e)&&(f=e,e=""),this._handlers.unshift({route:b,callback:function(b){g=h._getParams(),d(f)&&f.apply(h,[a.location.pathname,g,b]),h._backboneEventsAugmented&&(h.trigger.apply(h,["route:"+e].concat(g,b)),h.trigger("route",e,g,b))}}),this},destroyRoutes:function(){this._handlers=[]},navigate:function(b,c){c=c||{},c.state=c.state||{},a.history[c.replace?"replaceState":"pushState"](c.state,document.title,b),(void 0===c.trigger||c.trigger)&&this._loadUrl(c.state)},_getParams:function(b){for(var c,d=/\+/g,e=/([^&=]+)=?([^&]*)/g,f=function(a){return decodeURIComponent(a.replace(d," "))},g=b?b.search.substring(1):a.location.search.substring(1),h={};c=e.exec(g);)h[f(c[1])]=f(c[2]);return h},_routeToRegExp:function(a){return a=a.replace(i,"\\$&").replace(f,"(?:$1)?").replace(g,function(a,b){return b?a:"([^/]+)"}).replace(h,"(.*?)"),new RegExp("^"+a+"$")},_stripRoot:function(a){var b;return this.root?(b=this.root.replace(k,""),a=0===a.indexOf(b)?a.substr(b.length):void 0):a},_backboneEvents:function(){return!this.Backbone||this._backboneEventsAugmented?this:(b(this,Backbone.Events),this._backboneEventsAugmented=!0,void 0)},_bindPopState:function(){var b=this;this._popstateListener=a.addEventListener("popstate",function(a){b._loadUrl(a.state)})},_bindRoutes:function(){var a;if(!this.routes||this._routesBound)return this;a=d(this.routes)?this.routes():this.routes;for(var b in this.routes)this.route(b,this.routes[b]);return this._routesBound=!0,this},_isNewUrl:function(){var b=this._getParams();if(this._getParams(this._lastUrl),!this.onNewUrlOnly)return!0;for(var c in b)if(b[c]!==prevParams[c])return!0;return a.location.pathname!==this._lastUrl.pathname},_loadUrl:function(b){var c=this._handlers,d=this._stripRoot(a.location.pathname),e=d?c.length:0;b=b||{},e=this._isNewUrl()?e:0;for(var f=0;e>f;f++)if(c[f].route.test(d)){c[f].callback(b),this._lastUrl={pathname:a.location.pathname,search:a.location.search};break}return this}},a.define&&d(a.define)?a.define(e):a.hermes=e}(this);